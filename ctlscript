#!/bin/bash

usage() {
    echo "Usage:"
    echo
    echo "  ctlscript [--scope system|home|all] install                 - copy the files from the git repository to the system"
    echo "  ctlscript [--scope system|home|all] update                  - update the files in the git repository with those of the system"
	echo "  ctlscript restore <timestamp>                               - restore a backup made by the install command"
}


# Parse the options
scope="all"
while [ -n "$1" ]; do
	case "$1" in
		--scope)
			shift
			case $1 in
				system|home|all)
					scope=$1
					shift
					;;
				*)
					echo "Unknown scope: $1"
					exit 1;;
			esac
			;;
		--*)
			echo "Unknown option: $1"
			usage
			exit 1;;
		*)
			break;;
	esac
done


# Parse the commands
if [ -n $1 ]; then
	case "$1" in
		install|update|restore)
			command=$1
			shift
			;;
		*)
			echo "Unknown command: $1"
			usage
			exit 1;;
	esac
fi
if [ -n "$1" ]; then
	case "$command" in
		restore)
			# The restore command NEEDS a backup directory
			if [ -d "backup/$1" ]; then
				backupdir="backup/$1"
				shift
			else
				echo "There is no directory in backup/ with the given timestamp."
				exit 1
			fi
			;;
		*)
			echo "This command doesn't accept any additional arguments."
			echo "Use 'ctlscript --help' for more information."
			exit 1
			;;
	esac
fi

##########################################################################################

# Retrieves the real paths on the system from the structure of the files directory
# and depending on the options given
getsystempaths()
{
	case "$scope" in
		system)
			files=$(find files -not \( -path files/home -prune \) -type f)
			;;
		home)
			files=$(find files/home/ -type f)
			;;
		all)
			files=$(find files -type f)
			;;
	esac

	for item in $files; do
		name=${item//files/}
		if [[ "$name" =~ /home/(.*) ]]; then
			name="$HOME/${BASH_REMATCH[1]}"
		fi
		echo "$name"
	done
}

# Install
if [ "$command" = "install" ]; then
	# Create a backup associated to the actual timestamp
	timestamp=$(date +%s)
	mkdir -p backup/"$timestamp"

	# Copy the respective file in the home directory making first a backup
	files=$(getsystempaths)
	for item in $files; do
		if [ -f "$item" ]; then
			cp --parents $item backup/"$timestamp"/
		fi
		reponame=${item//$HOME/\/home}
		if [[ "$item" =~ $HOME/(.*) ]]; then
			cp files"$reponame" "$item"
		else
			sudo cp files"$reponame" "$item"
		fi
		echo "$item replaced"
	done
	exit 1
fi


# Update
if [ "$command" = "update" ]; then
	files=$(getsystempaths)
	for item in $files; do
		reponame=${item//$HOME/\/home}
		cp -p "$item" files"$reponame"
		echo "files$reponame updated"
	done
	exit 1
fi


# Restore
if [ "$command" = "restore" ]; then
	files=$(find "$backupdir" -type f)
	for item in $files; do
		name=${item#$backupdir}
		if [[ "$name" =~ $HOME/(.*) ]]; then
			cp "$item" "$name"
		else
			sudo cp "$item" "$name"
		fi
		echo "$name restored"
	done
	exit 1
fi
